object = mouse_brain,
ident.1 = 'Pvalb',
ident.2 = 'Sst',
only.pos = TRUE,
test.use = 'LR',
latent.vars = 'nCount_peaks'
)
# get top differentially accessible peaks
top.da.peak <- rownames(da_peaks[da_peaks$p_val < 0.005, ])
# test enrichment
enriched.motifs <- FindMotifs(
object = mouse_brain,
features = top.da.peak
)
enriched.motifs
MotifPlot(
object = mouse_brain,
motifs = head(rownames(enriched.motifs))
)
mouse_brain <- RunChromVAR(
object = mouse_brain,
genome = BSgenome.Mmusculus.UCSC.mm10
)
DefaultAssay(mouse_brain) <- 'chromvar'
# look at the activity of Mef2c
p2 <- FeaturePlot(
object = mouse_brain,
features = "MA0497.1",
min.cutoff = 'q10',
max.cutoff = 'q90',
pt.size = 0.1
)
p1 + p2
differential.activity <- FindMarkers(
object = mouse_brain,
ident.1 = 'Pvalb',
ident.2 = 'Sst',
only.pos = TRUE,
test.use = 'LR',
latent.vars = 'nCount_peaks'
)
MotifPlot(
object = mouse_brain,
motifs = head(rownames(differential.activity)),
assay = 'peaks'
)
saveRDS(mouse_brain,"adult_mouse_brain2.rds")
# Get a list of motif position frequency matrices from the JASPAR database
pfm <- getMatrixSet(
x = JASPAR2020,
opts = list(species = 10090, all_versions = FALSE)
)
pfm
# Get a list of motif position frequency matrices from the JASPAR database
pfm <- getMatrixSet(
x = JASPAR2020,
opts = list(species = 9606, all_versions = FALSE)
)
# Get a list of motif position frequency matrices from the JASPAR database
pfm <- getMatrixSet(
x = JASPAR2020,
opts = list(species = 9606, all_versions = FALSE)
)
pfm
rm(counts)
rm(allen_rna)
rm(brain)
rm(annotations)
rm(gene.activities)
View(metadata)
rm(brain_assay)
rm(transfer.anchors)
save.image("mouse_brain_motif.rdata")
knitr::opts_chunk$set(echo = TRUE)
library(Signac)
library(Seurat)
library(JASPAR2020)
library(TFBSTools)
library(BSgenome.Mmusculus.UCSC.mm10)
library(patchwork)
set.seed(1234)
library(Seurat)
#
knitr::opts_knit$set(root.dir = "C:/Users/flyku/Desktop/DESSO/analysis")
knitr::opts_knit$set(echo=F)
knitr::opts_knit$set(message=F)
setwd("C:/Users/flyku/Desktop/DESSO/analysis")
p1 <- DimPlot(mouse_brain, label = TRUE, pt.size = 0.1) + NoLegend()
p1
# get top differentially accessible peaks
top.da.peak <- rownames(da_peaks[da_peaks$p_val < 0.005, ])
top.da.peak
enriched.motifs
knitr::opts_chunk$set(echo = TRUE)
library(Signac)
library(Seurat)
library(JASPAR2020)
library(TFBSTools)
library(BSgenome.Mmusculus.UCSC.mm10)
library(patchwork)
set.seed(1234)
library(DT)
library(Seurat)
#
knitr::opts_knit$set(root.dir = "C:/Users/flyku/Desktop/DESSO/analysis")
knitr::opts_knit$set(echo=F)
knitr::opts_knit$set(message=F)
setwd("C:/Users/flyku/Desktop/DESSO/analysis")
DT::datatable(enriched.motifs)
MotifPlot(
object = mouse_brain,
motifs = head(rownames(enriched.motifs))
)
DefaultAssay(mouse_brain)
mouse_brain
DefaultAssay(mouse_brain) <- "peaks"
MotifPlot(
object = mouse_brain,
motifs = head(rownames(enriched.motifs))
)
DefaultAssay(mouse_brain) <- 'chromvar'
# look at the activity of Mef2c
p2 <- FeaturePlot(
object = mouse_brain,
features = "MA0497.1",
min.cutoff = 'q10',
max.cutoff = 'q90',
pt.size = 0.1
)
p1 + p2
mouse_brain
DefaultAssay(mouse_brain) <- 'chromvar'
# look at the activity of Mef2c
p2 <- FeaturePlot(
object = mouse_brain,
features = "MA0497.1",
min.cutoff = 'q10',
max.cutoff = 'q90',
pt.size = 0.1
)
p1 + p2
DefaultAssay(mouse_brain) <- 'RNA'
p3 <- <- FeaturePlot(
p3 <-  FeaturePlot(
object = mouse_brain,
features = "MA0497.1",
min.cutoff = 'q10',
max.cutoff = 'q90',
pt.size = 0.1
)
FeaturePlot
p3 <-  FeaturePlot(
object = mouse_brain,
features = "MEF2C",
min.cutoff = 'q10',
max.cutoff = 'q90',
pt.size = 0.1
)
p3 <-  FeaturePlot(
object = mouse_brain,
features = "Mef2c",
min.cutoff = 'q10',
max.cutoff = 'q90',
pt.size = 0.1
)
mouse_brain
GetAssayData(mouse_brain,slot = "data")
p3 <-  FeaturePlot(
object = mouse_brain,
features = "Mef2a",
min.cutoff = 'q10',
max.cutoff = 'q90',
pt.size = 0.1
)
p3 <-  FeaturePlot(
object = mouse_brain,
features = "Mef2a",
pt.size = 0.1
)
p3
p3 <-  FeaturePlot(
object = mouse_brain,
features = "Mef2c",
pt.size = 0.1
)
p1 + p2 + p3
p1 + p2 + p3
p1 + p2 + p3
MotifPlot(
object = mouse_brain,
motifs = head(rownames(differential.activity)),
assay = 'peaks'
)
CoveragePlot(
object = mouse_brain,
region = c("Mefc2", "Gad2"),
extend.upstream = 1000,
extend.downstream = 1000,
ncol = 1
)
DefaultAssay(mouse_brain) <- "peaks"
CoveragePlot(
object = mouse_brain,
region = c("Mefc2", "Gad2"),
extend.upstream = 1000,
extend.downstream = 1000,
ncol = 1
)
DefaultAssay(mouse_brain) <- "RNA"
CoveragePlot(
object = mouse_brain,
region = c("Mefc2"),
extend.upstream = 1000,
extend.downstream = 1000,
ncol = 1
)
DefaultAssay(mouse_brain) <- "peaks"
CoveragePlot(
object = mouse_brain,
region = c("Mefc2"),
extend.upstream = 1000,
extend.downstream = 1000,
ncol = 1
)
DefaultAssay(mouse_brain) <- "peaks"
CoveragePlot(
object = mouse_brain,
region = c("Mef2c"),
extend.upstream = 1000,
extend.downstream = 1000,
ncol = 1
)
p4 <- CoveragePlot(
object = mouse_brain,
region = c("Mef2c"),
extend.upstream = 1000,
extend.downstream = 1000,
ncol = 1
)
p4
p5 <- PlotFootprint(mouse_brain, features = c("Mef2c"))
mouse_brain
mouse_brain2 <- Footprint(
object = mouse_brain,
motif.name = c("Mef2c"),
genome = BSgenome.Mmusculus.UCSC.mm10
)
library(motifmatchr)
library(JASPAR2018)
library(motifmatchr)
library(JASPAR2020)
library(TFBSTools)
# extract position frequency matrices for the motifs
pwm <- getMatrixSet(
x = JASPAR2020,
opts = list(species = 9606, all_versions = FALSE)
)
# scan the genome and record the position of each motif using motifmatchr
motif.positions <- matchMotifs(
pwms = pwm,
subject = granges(mouse_brain),
out = 'positions',
genome = 'hg19'
)
mouse_brain
granges(mouse_brain)
h
# scan the genome and record the position of each motif using motifmatchr
motif.positions <- matchMotifs(
pwms = pwm,
subject = granges(mouse_brain),
out = 'positions',
genome = 'mm10'
)
mouse_brain
# create a Motif object and add it to the assay
motif <- CreateMotifObject(
positions = motif.positions,
pwm = pwm
)
motif
motif.positions
# create a Motif object and add it to the assay
motif <- CreateMotifObject(
positions = motif.positions,
pwm = pwm
)
motif
motif.positions
mouse_brain1 <- SetAssayData(
object = mouse_brain,
slot = 'motifs',
new.data = motif
)
mouse_brain1
BSgenome.Mmusculus.UCSC.mm10
p5 <- PlotFootprint(mouse_brain, features = c("Mef2c"))
mouse_brain3 <- Footprint(
object = mouse_brain,
motif.name = c("Mef2c"),
genome = BSgenome.Mmusculus.UCSC.mm10
)
pwm
# create a Motif object and add it to the assay
motif <- CreateMotifObject(
positions = motif.positions,
pwm = pwm
)
mouse_brain1 <- SetAssayData(
object = mouse_brain,
slot = 'motifs',
new.data = motif
)
mouse_brain1 <- Footprint(
object = mouse_brain1,
motif.name = c("GATA2", "CEBPA", "EBF1"),
genome = BSgenome.Hsapiens.UCSC.hg19
)
mouse_brain1 <- Footprint(
object = mouse_brain1,
motif.name = c("Mef2c"),
genome = BSgenome.Mmusculus.UCSC.mm10
)
mouse_brain1
mouse_brain@active.assay
mouse_brain@active.ident
mouse_brain@meta.data
GetAssayData(mouse_brain, slot="motifs")
mouse_brain1 <- Footprint(
object = mouse_brain,
motif.name = c("Mef2c"),
genome = BSgenome.Mmusculus.UCSC.mm10
)
mouse_brain1 <- Footprint(
object = mouse_brain,
motif.name = c("MA0497.1"),
genome = BSgenome.Mmusculus.UCSC.mm10
)
# plot the footprint data for each group of cells
p5 <- PlotFootprint(mouse_brain1, features = c("MA0497.1"))
p5
save.image("mouse_brain_motif.rdata")
#mouse_brain1 <- Footprint(
#  object = mouse_brain,
#  motif.name = c("MA0497.1"),
#  genome = BSgenome.Mmusculus.UCSC.mm10
#)
mouse_brain <- mouse_brain1
#mouse_brain1 <- Footprint(
#  object = mouse_brain,
#  motif.name = c("MA0497.1"),
#  genome = BSgenome.Mmusculus.UCSC.mm10
#)
rm(mouse_brain1)
save.image("mouse_brain_motif.rdata")
install.packages("C:/Users/flyku/Downloads/plumber_1.0.0.zip", repos = NULL, type = "win.binary", lib="C:/Program Files/Microsoft/R Open/R-4.0.2/library")
library(plumber)
#setwd('/var/www/nodejs/iris3-backend/plumber')
plumber::pr("iris3.R") %>% plumber::pr_run(host="0.0.0.0",port=8000)
install.packages("webutils", lib="C:/Program Files/Microsoft/R Open/R-4.0.2/library")
library(plumber)
setwd('C:/Users/flyku/Documents/GitHub/iris3-backend/plumber')
#setwd('/var/www/nodejs/iris3-backend/plumber')
plumber::pr("iris3.R") %>% plumber::pr_run(host="0.0.0.0",port=8000)
suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(hdf5r))
suppressPackageStartupMessages(library(jsonlite))
suppressPackageStartupMessages(library(ggplot2))
library(patchwork)
library(fst)
library(dplyr)
library(tibble)
library(scales)
# Global variable for each docker session
raw_expr_data <- NULL
obj <- NULL
variable_genes <- NULL
filename <- 'Zeisel_expression.fst'
meta <- read.csv('Zeisel_index_label.csv')
ident_idx <- 1
filename
min_cells
min_cells=1
## test
min_cells=1
min_genes=200
nVariableFeatures=3000
percentMt=5
removeRibosome=FALSE
raw_expr_data <<- read.fst(filename)
rownames(raw_expr_data) <- NULL
raw_expr_data <- column_to_rownames(raw_expr_data, "X1")
raw_obj <- CreateSeuratObject(raw_expr_data)
obj <<- CreateSeuratObject(raw_expr_data,min.cells = min_cells, min.features = min_genes)
empty_ident <- as.factor(obj$orig.ident)
levels(empty_ident) <- rep("empty_ident",length(levels(empty_ident)))
obj <<- AddMetaData(obj, metadata = empty_ident,col.name = "empty_ident")
Idents(obj) <- obj$orig.ident
obj[["percent.mt"]] <- PercentageFeatureSet(obj, pattern = "^MT-")
#obj[["percent.ribo"]] <<- PercentageFeatureSet(obj, pattern = "^MT-")
#obj[["percent.mt"]] <- PercentageFeatureSet(obj, pattern = "^MT-")
rb.genes <- rownames(obj)[grep("^Rp[sl][[:digit:]]",rownames(obj))]
percent.ribo <- Matrix::colSums(obj[rb.genes,])/Matrix::colSums(obj)*100
obj <- AddMetaData(obj, percent.ribo, col.name = "percent.ribo")
#obj <- subset(obj, subset = percent.mt < as.numeric(percentMt))
raw_percent_zero <- length(which((as.matrix(GetAssayData(raw_obj)) > 0)))/length(GetAssayData(raw_obj))
filter_percent_zero <- length(which((as.matrix(GetAssayData(obj)) > 0)))/length(GetAssayData(obj))
raw_mean_expr <- mean(as.matrix(GetAssayData(raw_obj)))
filter_mean_expr <- mean(as.matrix(GetAssayData(obj)))
obj <<- FindVariableFeatures(obj, selection.method = "vst", nfeatures = as.numeric(nVariableFeatures),verbose = F)
nPCs=20
resolution=0.5
print('run cluster calculation')
print(nPCs)
nPCs <- as.numeric(nPCs)
resolution <- as.numeric(resolution)
obj <- NormalizeData(obj,verbose = F)
obj <- ScaleData(obj, features = rownames(obj),verbose = F)
variable_genes <<- VariableFeatures(obj)
#Idents(obj) <- obj$cell_type
#print(obj)
if(nPCs > ncol(obj)){
nPC <- ncol(obj)
}
obj <- RunPCA(obj, features = variable_genes, npcs = nPCs,verbose = F)
obj <- FindNeighbors(obj, dims = 1:nPCs,verbose = F)
obj <- FindClusters(obj, resolution = resolution,verbose = F)
obj <<- RunUMAP(obj, dims = 1:nPCs,n.neighbors = 15,verbose = F)
return(list(
n_seurat_clusters = length(levels(obj$seurat_clusters))
))
n_seurat_clusters
length(levels(obj$seurat_clusters))
ident1=1
ident2=2
min_pct=0.2
min_lfc=0.5
#ident_idx=8
print('run deg')
print(ident1)
Idents(obj) <- obj@meta.data[,ident_idx]
this_markers <- FindMarkers(obj, ident.1 = ident1, ident.2 = ident2, min.pct =min_pct, logfc.threshold = min_lfc)
ident_idx
Idents(obj)
ident_idx=8
#ident_idx=8
print('run deg')
Idents(obj) <- obj@meta.data[,ident_idx]
(obj)
Idents(obj)
Idents(obj) <- obj@meta.data[,ident_idx]
this_markers <- FindMarkers(obj, ident.1 = ident1, ident.2 = ident2, min.pct =min_pct, logfc.threshold = min_lfc)
this_markers <- rownames_to_column(this_markers,"gene")
this_markers
Idents(obj) <- obj@meta.data[,ident_idx]
plot <- VlnPlot(obj, gene)
gene="Gad1"
Idents(obj) <- obj@meta.data[,ident_idx]
plot <- VlnPlot(obj, gene)
plot
source("functions.R")
ident_idx
obj@meta.data[,ident_idx]
obj@meta.data
this_text <- colnames(obj@meta.data)[ident_idx]
this_text
#plot <- DimPlot(obj,reduction = "umap")
plot <- Plot.cluster2D(obj, txt = this_text)
library(Polychrome)
#plot <- DimPlot(obj,reduction = "umap")
plot <- Plot.cluster2D(obj, txt = this_text)
plot
#plot <- DimPlot(obj,reduction = "umap")
plot <- Plot.cluster2D(obj, txt = this_text, pt_size = 0.3)
return(print(plot))
Plot.cluster2D(obj, txt = this_text, pt_size = 0.3)
#plot <- DimPlot(obj,reduction = "umap")
plot <- Plot.cluster2D(obj, txt = this_text, pt_size = 0.4)
plot
plot <- FeaturePlot(obj, gene)
plot
#setwd('/var/www/nodejs/iris3-backend/plumber')
plumber::pr("iris3.R") %>% plumber::pr_run(host="0.0.0.0",port=8000)
combine_regulon <- read.table("2020041684528_combine_regulon.txt", sep = "\t")
combine_regulon
combine_regulon <- read.table("2020041684528_combine_regulon.txt", sep = "\t", header = T)
View(combine_regulon)
list(
combine_regulon
)
return(list(
as.list(combine_regulon)
))
as.list(combine_regulon)
as.list(combine_regulon[1:3,])
vargenes <- VariableFeatures(obj)
Idents(obj) <- obj@meta.data$empty_ident
this_obj <- as.matrix(GetAssayData(subset(obj, features = vargenes), slot = "data"))
row_min <- apply(this_obj, 1, min)
row_sd <- apply(this_obj, 1, sd)
row_max <- apply(this_obj, 1, max)
result <- data.frame(gene=rownames(this_obj), mean=rowMeans(this_obj), std=row_sd, min=row_min, max=row_max)
list(result)
library(plumber)
setwd('C:/Users/flyku/Documents/GitHub/iris3-backend/plumber')
#setwd('/var/www/nodejs/iris3-backend/plumber')
plumber::pr("iris3.R") %>% plumber::pr_run(host="0.0.0.0",port=8000)
#plumber::pr("multiome.R") %>% plumber::pr_run(host="0.0.0.0",port=8000)
library(plumber)
setwd('C:/Users/flyku/Documents/GitHub/iris3-backend/plumber')
#setwd('/var/www/nodejs/iris3-backend/plumber')
plumber::pr("iris3.R") %>% plumber::pr_run(host="0.0.0.0",port=8000)
